{% set form_suffix = config.id or 'new' %}
<!--
  x-data 설명
  - retentionMode: 서버에서 렌더링된 초기 보존 모드 문자열 ('days' | 'count' | 'sync').
  - retentionValue (3항 연산자): 폼의 `retention` 입력값과 양방향 바인딩되는 숫자값.
      초기값 우선순위: 서버의 `config.retention` 값 존재 -> 그 값 사용,
      없으면 모드별 기본값 사용 (days: 60, count: 10, sync: 0).
  x-init (watch): retentionMode가 변경되면 retentionValue를 자동으로 모드별 기본값(60/10/0)으로 재설정합니다.
-->
<form id="sync-config-form-{{ form_suffix }}" hx-post="/filesync/config" hx-target="#sync-card-{{ config.id }}"
    hx-swap="outerHTML" class="space-y-4"
    hx-on:htmx:after-request="if (window.Toast?.info) { Toast.info('설정이 저장되었습니다.', { position: 'top-center', duration: 3000 }); }"
    x-data="{ 
        retentionMode: '{{ config.retention_mode }}', 
        retentionValue: {{ config.retention if config.retention is not none else (60 if config.retention_mode == 'days' else (10 if config.retention_mode == 'count' else 0)) }}
    }"
    x-init="$watch('retentionMode', value => { retentionValue = value === 'days' ? 60 : (value === 'count' ? 10 : 0) })">
    <input id="config-id-{{ form_suffix }}" type="hidden" name="id" value="{{ config.id }}">
    <input id="config-interval-{{ form_suffix }}" type="hidden" name="interval" value="{{ config.interval or 0 }}">
    <div id="config-name-pattern-{{ form_suffix }}" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label for="config-name-{{ form_suffix }}" class="block text-sm font-medium text-gray-700">Config Name</label>
            <input id="config-name-{{ form_suffix }}" type="text" name="name" value="{{ config.name }}"
                class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
            <label for="pattern-{{ form_suffix }}" class="block text-sm font-medium text-gray-700">Pattern (쉼표로 구분)</label>
            <input id="pattern-{{ form_suffix }}" type="text" name="pattern" value="{{ config.pattern }}"
                placeholder="예: *.bak,*.zip"
                class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
        </div>
    </div>

    <div>
        <label for="source-path-{{ form_suffix }}" class="block text-sm font-medium text-gray-700">Source Path</label>
        <input id="source-path-{{ form_suffix }}" type="text" name="source_path" value="{{ config.source_path }}" placeholder="예: /Users/user/Documents"
            class="mt-1 block w-full border border-gray-300 rounded px-3 py-2" required>
    </div>

    <div>
        <label for="replica-path-{{ form_suffix }}" class="block text-sm font-medium text-gray-700">Replica Path</label>
        <input id="replica-path-{{ form_suffix }}" type="text" name="replica_path" value="{{ config.replica_path }}"
            placeholder="예: /Users/user/Documents_backup" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2" required>
    </div>

    <div id="schedule-retention-row-{{ form_suffix }}" class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">
        <div class="lg:col-span-1">
            <label for="retention-mode-{{ form_suffix }}" class="block text-sm font-medium text-gray-700">Retention Mode</label>
            <select id="retention-mode-{{ form_suffix }}" name="retention_mode"
                class="mt-1 block w-full border border-gray-300 rounded px-3 py-2 select-arrow" x-model="retentionMode">
                <option value="days">기간(일)</option>
                <option value="count">파일 개수</option>
                <option value="sync">동기화(단방향)</option>
            </select>
            <p class="mt-1 text-xs text-gray-500">보존 기준을 선택하세요.</p>
        </div>
        <div class="lg:col-span-2">
            <label class="block text-sm font-medium text-gray-700">Retention Value</label>
            <div id="retention-value-wrapper-{{ form_suffix }}" class="space-y-1">
                <input id="retention-value-{{ form_suffix }}" type="number" name="retention"
                    x-model.number="retentionValue"
                    class="mt-1 block w-full border border-gray-300 rounded px-3 py-2"
                    min="0"
                    :placeholder="retentionMode === 'count' ? '유지할 파일 개수' : (retentionMode === 'days' ? '유지할 일수' : '')"
                    :disabled="retentionMode === 'sync'">
                <p class="text-xs text-gray-500"
                    x-text="retentionMode === 'count' ? '파일 개수 모드일 때 유지할 최대 개수를 입력하세요.' : (retentionMode === 'days' ? '기간(일) 기준으로 유지할 일수를 입력하세요.' : '동기화 모드에서는 보존 값이 비활성화됩니다.')">
                </p>
            </div>
        </div>
    </div>

    <div class="pt-4 flex gap-4">
        <button id="save-config-{{ form_suffix }}" type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded border-none flex-1">
            Save Configuration
        </button>
    </div>

    {% if message %}
    <div id="config-message-{{ form_suffix }}" class="mt-4 p-3 bg-green-100 text-green-700 rounded text-center">
        {{ message }}
    </div>
    {% endif %}
</form>
